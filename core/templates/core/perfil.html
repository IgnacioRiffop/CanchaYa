{% extends 'core/base.html' %}
{% load static %}

{% block title %}Mi Perfil | CanchaYa{% endblock %}

{% block contenido %}
<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card perfil-card shadow-lg border-0 rounded-4 overflow-hidden">
        <!-- 游댳 Encabezado -->
        <div class="card-header bg-success text-white d-flex align-items-center py-4">
          <i class="fa-solid fa-user-circle fa-3x me-3"></i>
          <div>
            <h3 class="fw-bold mb-0">Mi Perfil</h3>
            <small>Informaci칩n personal vinculada a tu cuenta</small>
          </div>
        </div>

        <!-- 游댳 Contenido -->
        <div class="card-body bg-light p-5">
          <div class="row mb-4 text-center">
            <div class="col-12">
              <img src="{% static 'img/avatar_default.webp' %}" alt="Foto de perfil" class="perfil-avatar shadow-sm">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold text-muted">Nombre</label>
              <div class="form-control bg-white shadow-sm">{{ nombre|default:"No disponible" }}</div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold text-muted">Apellido</label>
              <div class="form-control bg-white shadow-sm">{{ apellido_usuario|default:"No disponible" }}</div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-semibold text-muted">Correo electr칩nico</label>
            <div class="form-control bg-white shadow-sm">{{ email_usuario|default:user.email }}</div>
          </div>

          <!-- 游댳 Botones -->
          <div class="text-center mt-4">
            <a href="{% url 'index' %}" class="btn btn-outline-success rounded-pill px-4 py-2 me-2">
              <i class="fa-solid fa-house"></i> Volver al inicio
            </a>
            <a href="#" class="btn btn-success rounded-pill px-4 py-2" id="btnEditarPerfil">
              <i class="fa-solid fa-pen-to-square"></i> Editar datos
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block css %}
<style>
  .perfil-card {
    transition: all 0.3s ease;
  }

  .perfil-card:hover {
    transform: translateY(-3px);
  }

  .perfil-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #28a745;
  }

  .form-control {
    border: none;
    font-weight: 500;
  }

  .form-control.bg-white {
    cursor: default;
  }

  .btn-outline-success:hover {
    background-color: #28a745;
    color: #fff;
  }

  @media (max-width: 768px) {
    .perfil-card {
      border-radius: 1rem;
    }
  }
</style>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById('btnEditarPerfil').addEventListener('click', async () => {
  const { value: formValues } = await Swal.fire({
    title: 'Editar perfil',
    html:
      `<div class="text-start">
        <label class="form-label fw-semibold mb-1">Nombre</label>
        <input id="nombre" type="text" class="swal2-input" value="{{ nombre|default:'' }}" maxlength="40" placeholder="Ej: Daniel">
        <label class="form-label fw-semibold mb-1 mt-3">Apellido</label>
        <input id="apellido" type="text" class="swal2-input" value="{{ apellido_usuario|default:'' }}" maxlength="40" placeholder="Ej: Riffo">
      </div>`,
    focusConfirm: false,
    confirmButtonText: 'Guardar cambios',
    confirmButtonColor: '#28a745',
    showCancelButton: true,
    cancelButtonText: 'Cancelar',
    cancelButtonColor: '#6c757d',
    preConfirm: () => {
      const nombre = document.getElementById('nombre').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      const regex = /^[A-Za-z츼칄칈칍칔치칠칤칩칰칌침 ]+$/;

      if (!nombre || !apellido)
        return Swal.showValidationMessage('Todos los campos son obligatorios.');

      if (nombre.length < 3 || apellido.length < 3)
        return Swal.showValidationMessage('Cada campo debe tener al menos 3 caracteres.');

      if (!regex.test(nombre) || !regex.test(apellido))
        return Swal.showValidationMessage('Solo se permiten letras en los nombres.');

      return { nombre, apellido };
    }
  });

  if (formValues) {
    const formData = new FormData();
    formData.append('nombre', formValues.nombre);
    formData.append('apellido', formValues.apellido);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const response = await fetch("{% url 'editar_perfil' %}", {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (data.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Perfil actualizado',
        html: '<i class="fa-solid fa-user-check fa-3x text-success mb-3"></i><p>Se guardaron los cambios correctamente.</p>',
        showConfirmButton: false,
        timer: 2200,
        background: '#f8fff8'
      }).then(() => {
        location.reload();
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.msg,
        confirmButtonColor: '#28a745'
      });
    }
  }
});
</script>
{% endblock %}
